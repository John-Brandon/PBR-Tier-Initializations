---
title: 'Draft Two Stock Pop Dy Model: PBR Tier System'
author: "John R. Brandon"
date: "14 April 2015"
output: html_document
---

This is a draft outline of equations forming the underlying framework for the PBR Tier System. 

# First let's play around with a potential approach for coding the pop.dy model in *R*
To speed computations in *R*, we can frame the model in terms of matrix multiplication (in order to avoid loops in *R*). The trick in this step is to recognize that plus-group can be considered a stage-group. 

Let's start with a simplified example. Here will assume there are only ages: 1, 2, and 2+ (and ignore sex-structure). Also assume that only the age 2+ animals are mature. 

  Right     Left     Center     Default
-------     ------ ----------   -------
     12     12        12            12
    123     123       123          123
      1     1          1             1

Table:  Table 1. Demonstration of simple table syntax.    

```{r}

```


# Population Dynamics Model
The population dynamics for each stock were based on an age- and sex-structured model. This model is based on those which have been used by NMFS and the IWC (e.g. Punt and Wade YYYY; IWC YYYY). It differs from the surplus production (age-aggregated) model used in previous work on PBR (e.g. Wade 1998). For simple scenarios, the two modeling approaches are equivalent. However, the more complex age- and sex-structured population dynamics model allows a wider spectrum of scenarios to be evaluated. 

__What age to use for the plus group, given this is modelling a generic species?__ 

__Presumably starting with cetaceans, are we interested in pinnipeds?__

$$
N_{t+1, a = 0}^{m/f, i, j} = N_{t, a = mat+}^{f, i, j} 
$$
$$
N_{t+1, a}^{m/f, i, j} = N_{t, a}^{m/f, i, j} - C_{i,j}^{t}   
$$

## Density Dependence
Density dependence was assumed to act through the birth rate, according to the Pella-Tomlinson mdoel: 
$$
B_t^{i} = max(0, B_{eq} + (B_{max} - B_{eq})[1-(N_{t, 1+}^{i} / K_{1+}^{i})^{\theta}])
$$
Where $\theta$ is the shape parameter, assumed to equal 2.39 (or MNPL of approximately 60% of *K*).

# Heading 3
Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.

## NOTES FOR DEFINING SCENARIOS
Lots of seemingly *ad hoc* guidelines (i.e. provided without any reference to formal testing within an MSE) in the most recent GAMMS (NMFS 2005). Might also be worth re-reading earlier GAMMS to see if other recommendations are currently in use, but have not been subjected to formal MSE. 

# Appendix A
This appendix provides an example of reading a FORTRAN ouput file and creating a plot from those values in R. The files referenced below are available online, as part of this open-source project: 
https://github.com/John-Brandon/PBR-Tier-System

From GitHub repositories like this one you can fork any file, which will create a copy on your machine. If you are interested in collaborating on any code in Git repository, you can edit your forked copy of the code, and then submit a pull request to update the existing file in the repository. If you're new to Git and interested in learning more about version control for open-source code like this, there are good tutorials available on YouTube, *e.g.* https://www.youtube.com/user/GitHubGuides

There is a short FORTRAN program in the "PBRdev.f" file found in the PBR Tier System GitHub repository. If you want to compile and run the code, you will need a FORTRAN 90/95 compiler (I haven't tested compiling with F77, but suspect there might be formatting issues). There are free open-source compilers available online for different operating systems. I'm working under Mac OS 10.9.5 and use the *gfortran* 4.9.1 compiler (free, open source, GNU Fortran 95 compiler). No punch-cards were harmed during this exercise. 

If you're not familiar with the FORTRAN language, this code is meant to serve as an illustrative example of several common computing tasks using this language: (i) Calling a subroutine to read and return values from an input file; (ii) Looping over a range of parameter values [$CV_{N}$]; (iii) Calling a function to calculate and return a value of interest [$N_{min}$], given parameter values [$CV_{N}$'s, *etc.*]; and (iv) Writing the solutions, with the corresponding parameter value, to an output file. 

In this example, there is a single fixed value for: (i) $\hat{N}$, and (ii) *z*, the standard normal variate used when calculating $N_{min}$. The value for *z* in this example is 0.842, which corresponds to the lower 20th percentile of a log-normal distribution assumed for the uncertainty associated each abundance estimate. To provide a real-world example, $\hat{N}$ corresponds with a point estimate of abundance for the pelagic stock of Hawaiian false killer whales ($\hat{N}$ = 1042). The range of $CV_{N}$ values is 0.10 - 1.5. Where: 
$$
N_{min} = \frac{\hat{N}}{exp\left(z \sqrt{\ln(1 + CV_{N}^{2})}\right)}
$$

The FORTRAN code writes to the output file "Nmin.out".  At the minimum, you'll need a copy of "Nmin.out" on your machine to follow the example R code below. If you want, you can actually compile and run the FORTRAN program through R commands, and create the output file that way. An example of that process is provided below. Either way, you'll need to point R to the directory that contains the FORTRAN code / output file. I'm working under Mac OS X, and for me, the directory for the R command looks like this (you'll need to modify this for your machine):
```{r}
wdir = "~/Documents/2015 Work/PBR Tier System/Code"
```
To compile and run the FORTRAN file on my machine, the R commands I used are: 
```{r, echo=TRUE}
setwd(wdir) # set the working directory to where the *.f file resides
system("gfortran -o PBR_dev PBR_dev.f") # compile command in quotes
system("./PBR_dev") # runs the compiled FORTRAN program 
dir()
```

Next we'll use the "read.table()" function in R, and print the values of the output file. 
```{r}
out.file = paste(wdir, "Nmin.out", sep = "/")
Nmin = read.table(file = out.file, header = TRUE)
Nmin
```

Let's take a look at the structure of the "Nmin" object.
```{r}
str(Nmin)
```

So, we have a data.frame object in R (which is what we expect read.table to return). This is convienient, because we can use the powerful "ggplot2" package to plot data.frames:

```{r}
library(ggplot2)
ggplot(data = Nmin, aes(x = CV_N, y = N_min)) + geom_line() + geom_point()
```

__References__

IWC. YYYY. Report of the AWMP

NMFS. 2005. Revisions to Guidelines for Assessing Marine Mammal Stocks. 24 pp. Available at: http://www.nmfs.noaa.gov/pr/pdfs/sars/gamms2005.pdf 

Punt, A.E. and Wade, P.R. YYYY. ENP Gray Whale assessment

Wade, P.R. 1998. Calculating limits to the allowable human-caused mortality of cetaceans and pinnipeds. Mar Mamm Sci 14: 1-37.
